#include <iostream>
#include <string.h>
#include "functions.h"
using namespace std;

int main()
{
    string key = "59454C4C4F57205355424D4152494E45"; //YELLOW SUBMARINE
    string encrypted_text = "091230AADE3EB330DBAA4358F88D2A6CD5CF8355CB6823397AD43906DF4344557FC4837693C1A8EE3B40ACB2323FAD396F4EF50CBF02F853D84873973E430C3053C02A6F8DB2ED2708131056DF66965B876D513FCA5E956810A336E386BC767D598BEDE75B91FE5925659D0E6EA0F951A0B5AEEA59C0210AE292167FA250E294F23E3CA23ED297839E05350BDB5481DEA2D506DA41C4BC7192FF0A93B78138DB113055F8B6F49DF2A743BF4DC2FB6A845921C263315E2AC58FEEBD92C6B23A35FC8CA1B50A77BD8D274B32631A068B617A6F467F13680704B47DDCA997A7068A31047DCCC4D8C3FD355FDCD6ACB445869EA786A7ED03F5B431FF72F4FB14DFFA4D958C10EB57D1CF5CD10B4603CDD0C94DA3BF69DA01305A37D36F1D8A6C5EA1B60B1B1A008C67AFE20AC872DD1F3F69BC6497C78AFD57C219F03A6D0424AACF756E0B13D118315D25B38E3BE1E1E5D34A5F316283030866B6A2937F6FA43631D7EF5BBAC4BE9E66C0939F4050ED92FE0CE5C1443B7B23994F4C45E4670A9BDA946DDAAE4D170B9F3DAE6FB8DA30B8FE815651DC2F9331A449EA1A6C025D1090A27E1BED1A8B1882F4030115283534003B5F826E7C1D2A703F59B439F52F4C53AD5029C612BA4FA32B99C0303A2DD9D3E6BF16487AA6C1E9AC75207D1C755C7BA81FD9D85949FD4F76EF11A60BF454170A1740346A2F4E4BDB6C04885F391CAC765D1541D05EE47A09705FF925E2081AE6B93762B67B55B2273E9C54CE011A138F810E812A6EFFEB60CB9A78EB8122455C866CD7C25A4F391C1B374FD150BF3DC7038928241064CF01D58B183AA78BDC71B129FA45A3B92602B5D244A4474E85EE0600EAD3B292FE3C5A4B56B53DACFFB6F6078CBC706343ADDE44BE72705EABF14648D2FF7C55772766BC795BF276C29AB775D94B758A70D363636644635AC781C18BE5B8551ECEBB6F16FF2064257B263E1302EEBF9794C12DF096326419C59E16196AC4D5D0E8D0D3CD1365052D16E0290A88304C7A009C3A53CA0B664B1B0A9E8E0AF6BADA0A7E646D7A1AFEDCB0212CC5632F23D2450FF30E11E35EEF8A9ADE1E9664E6A8B80052C9223A22D8A6BD3323B3DBE31B0491CC51157F6B2B2E5657B361275951EC12B26A53BDE235882F89099A1E06A141213BEBC308DB56E3D3C481092E9DD57CBE6CF129AAD41D9D31AF87DE2F56494C78A7C94B3F294009019480435671FD2E1D363D47B9C859CC30E6FE713F6370DE0E184D530A608267AC2C3C45B6A249FC1467F1C83033AFD23050D65278645FFB7CA89AC7A6173106302621D216C438B677BF0B03AC6110F53035D3CF854AC972EE61BE10D55DC71E64B6BEAC91269F869FB479BAFD0A3A587EDDAB845A68978F3FA587BD00E9CD924E20C4848AC0297E1DD0BC7A9D6E2C9B65DC84AF3FB25E33D794A586F7490ECFA7F1F866EF19C1EA89B6FF1D47DC0E8B1803B958E31635EE5958E6C89BBD633DD688453798F20E51ED9E08BB9D642015C0CD7D287BED30D3CE5B54A7D3674894A034E3B0A1248D59A766EBE0206D77D0357EA8245694E0B42202C44D6BBBD7FFD8D17E2EB9E6EBEE8CCE286F5F7D099571125B35D1423DA487A601043CCFFDEB810ADEC8BF9F562CB3B543E0FF622FC4E1EF79EC44E28C07E05A3F6D196164AD266086A6571B1100306E0651AAC756F43AE17802865981433877CBF78B252E7DE874410A8E92F24AFECBE46079F799FE099546F631382D450358759283460177434209699B8CC8F585B1235361AB968CC56A9E3D001031E1E9050C17C6D72CCD231B000A3FEAF8C8F74A24DB2864CA6E5685012585A70A357EF08BDEE998018B81046CF6CC2D7BAA0CCA438B85DC2C4D1450F27C56798EE5F007310900EB87AC63642A95D67EE601218E282E7998C47F4F75EFF5F9DD96162484622029E660FA0CD06498251134937C9C765CD9CE58C81A4F8F43B5A078986D862B040436E04EEA69A8A3572DB359646FD569375BA56D72941BF47AA6A614E9B2AD3CA1D403D21A7DFB7289932377E637AFF09959E6578FC56E5BD5C0BB83BC68120863CE17C8BA1557CABDD112B3ECABFB50040C95DFA7A87478D114B0CDE05DA2429271A19EDDDAC2D8357D2522C2961F0CA671C293CE614B9EAFC5A2F95083B16B14A6433186146A38129A41A043406FA4549BBA68F1659D23D04138B58712F08B497446BDFCC64AFE94753B8B1F0B78956036C41DB716E8BC4DE2EF3DD9713158EEE26423D8FD1349AE0CDF71F32FD8376E6B9BACD42D868E8D4A0FFFB15066C4A0C4F214BD4897904ABE154DA1D05A800BB1F5F1CAF765AE71E5DA70E67C1AC0C02B2A8A86F6A961A9CDF8957574658C142EEE7C108985212F3E9084C5BAEEE339E4976C181B871F3318FA9ABD15DE8AED2D6C9774816B3E62030BCD7B5021B42E55910A331252641E1AC3994F038BEBD5F141B22538BA78CE128FD7020C2B4DCD30D149DD2453EF5D1AF722BE6B16820439D468FBAA2CE434A593CD92067523C1B8DEEC15ACC5632456160EE9B386526E15C5C2965EEDA353AE93C505481F2ED61E4B4C8E2A1595625D642E47AB48352C78359D64A68CF63673FA1D66A37E741042E75742B78A22E542A62AD53982366C4524DC4E57E119477A0A8E13A770998478D0447E256618346C5FE8A0F4F12232CA2B8AF4FB2474972463A88604636EC724C8590A7143C41410D5491422102F5DA703581DA96F7632792423B7C8FF5926D063A4F374BABC4AB7998AE316717990938107DF1BBC6CFB0795CBD123E07783129E2E7C2B549A952E47F79B67121A75908522C66E702D8103C0EB3EEEDE019B06646D3F42A70075922BBABAA273286131FE6F98858C289546ACD4055CD144A8C02F8ADC2F69D8795E847373E59DBA11CC9C192230FA8BB58275CC4446BE1654E8CE057E1F861294895BE59A572EF029088929D910D1D90A9238D72A6856A55AAC7A6A87668FFCF4BADB8C9FC71D8DDC2D9C8BB548B87DC371261C6935C42A1CFF3D12C95E44605655B19FB42E6892730EFA41A059DDA11BB5F970ACBA9FC0B642E276C4973054E8FF629AEF7F7E060603B91B75984F44CAE63208CA313BFDBBB27D5058C31DD63B5CBFC65EE3631A338CBF3E100CA7645F0A855900B512D8AED7ACE2E5DECF4B0C539D4AB7C3F0678C72205B7CB1A85C3BEFE4EAAAD12FCEBE37480FDE1431C69DA6748DB22B2DFE4709255D30B5119F00B1B6F94298CC48FFD933A237BE54951BC0E578307EA6A33AF988217C9B6DD871A639D2074E17DE263CD9335261398B2C0CD9957DAF995F48291462999D92A73369BCB29E07C943848C86CC65DD8B29D08C530A7158D9966587B07EDE22D00A5A60B03647AE01F1708ABE134C6AE01B5A4C8DEED703B90C4FCDB57186CB4A23C0C2D942D309BBEC5D136BB8DD32B2E330EDBDFB5F79F0213358F77375FA8ACE57C1CEC6DAD3E752EA6716FD84C7681E1B0F25DE72164193FDF97D483EE2078C8FA3C14EA2CD3565C15FDDDD142EDF37275AF8BB7D715267961222FFAD5FAF42B3C4E79734A81E3CA382DD1CFE7D6C3B066E7C16561381180AEB7C855922A5E2C31FCE285A42AD11F0D31020E8F3B8C97721EE68CD26BECBD838CF9D9145CEBD9789F8AB37F4684AD5FC111EEC5AF34725A1E0F9038F9C32E4409A45B7CEEEB6ECD441E5B2116F5DF1A52DD11F3F690AA53F54DF634A67887E1ABF729AA67A8AC6F529F368BF5AF0D0A4AA60D3FE132582C8B449DC470E61DBD5C156FEBC88B2CF19D176E801DEF37368D9631C6E72A442506932E984842794FD36C5C06930D24DEBD6E28D5B6701237F4CB579A1C62FB6758F4C12AEDCEC8E91C7E531A1C21148073D6D1F9867E57788BD4EEDF9CEB2AF4C3CDFC64257EFE289EF677F57E92C34A5AFC27FF0BCC399B1AD8410E7DD0A2766A2A974DBB212E57BD21F29D0B6F166C341D393D517B7C1DD54D4EA71DCBF8D41665E95CD3F65AF9FC3EB5360E19242335A143947177FBE7336410AFD0B16B627D197115DE418389957DD3E3C20D254663856017CCBB19E748D61";
    int subdivisions = encrypted_text.length()/32;
    int initialKey[4][4];
    int expandedKey[4][44];
    int encryptedArray[4][subdivisions*4];
    int decryptedArray[4][4];
    vector<int> temp_Vec;
    std::string temp1;
    std::string temp2;

    HexStringto4x4Array(key, initialKey);

    ExpandKey(initialKey, expandedKey);

    // encrypted text into a [4][n] int array
    // Creating the array
    for (int i = 0; i < subdivisions; i++)
    {
        int Counter = 0;
        temp1 = encrypted_text.substr(i*32,32);
        // cout << temp1 << endl;
        for (int i = 0; i < temp1.length() / 2; i++)
        {
            temp2 = temp1.substr(i * 2, 2);
            long n = strtol(temp2.c_str(), NULL, 16);
            temp_Vec.push_back(n);
        }

        for (int j = 0; j < 4; j++)
        {
            for (int k = 0; k < 4; k++)
            {
                encryptedArray[k][i*4 + j] = temp_Vec[Counter];
                Counter++;
            }
        }
        temp_Vec.clear();
    }

    //printing the array
    // for (int i = 0; i < 4; i++)
    // {
    //     for (int j = 0; j < subdivisions*4; j++)
    //     {
    //         cout << hex << encryptedArray[i][j] << "\t";
    //     }
    //     cout << endl;       
    // }

    // Encryption
    // XOR i*16 through i*16+16 with IV
    // encrypt i*16 through i*16+16
    // set IV to encrypted text

    int tempDecryptingArray[4][4];
    int tempIVArray[4][4];
    int initialIVArray[4][4] = {0};
    int plainTextArray[4][4];


    for (int i = 0; i < 4*subdivisions; i+=4)
    {
        for (int j = 0; j < 4; j++)
        {
            for (int k = 0; k < 4; k++)
            {
                tempDecryptingArray[k][j] = encryptedArray[k][i + j];
                tempIVArray[k][j] = encryptedArray[k][i + j];
            }
        }
        DecryptAES128BitArray(tempDecryptingArray, expandedKey, decryptedArray);

        XOR4x4Array(decryptedArray, initialIVArray, plainTextArray);

        cout << hexArraytoAscii(plainTextArray);

        copy4x4Array(tempIVArray, initialIVArray);
    }
}